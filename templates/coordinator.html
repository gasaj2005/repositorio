<!DOCTYPE html>
<html>

<head>
    <title>Coordinador - UCO</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <header>
        <h1>Panel de Coordinacion</h1>
        <button onclick="logout()">Cerrar Sesion</button>
    </header>
    <div class="container">
        <!-- HU1.1 & HU1.2 -->
        <div class="section">
            <h2>Gestion de Usuarios</h2>
            <div style="background:#eee; padding:10px;">
                <h3>Registrar Nuevo Usuario</h3>
                <select id="newRole">
                    <option value="Alumno">Alumno</option>
                    <option value="Tutor">Tutor</option>
                </select>
                <input type="text" id="newName" placeholder="Nombre">
                <input type="text" id="newSurname" placeholder="Apellidos">
                <input type="text" id="newEmail" placeholder="Correo">
                <input type="text" id="newPass" placeholder="Contrasena">
                <input type="text" id="newDegree" placeholder="Carrera (Solo Alumnos)">
                <button onclick="addUser()">Registrar</button>
            </div>
            <h3>Lista de Usuarios</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Rol/Info</th>
                        <th>Tutor ID</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>

        <!-- HU2.1 & HU2.2 -->
        <div class="section">
            <h2>Asignacion de Tutores</h2>
            <button onclick="autoAssign()">Asignar Automaticamente</button>
            <div style="margin-top:10px;">
                <h3>Asignacion Manual</h3>
                <select id="manualStuId">
                    <option value="">Cargando alumnos...</option>
                </select>
                <select id="manualTutId">
                    <option value="">Cargando tutores...</option>
                </select>
                <button onclick="manualAssign()">Asignar</button>
            </div>
        </div>

        <!-- HU3.3 -->
        <div class="section">
            <h2>Supervision de Chats</h2>
            <button onclick="loadAllChats()">Cargar Historial Completo</button>
            <div id="allChats" class="chat-window" style="height:200px;"></div>
        </div>
    </div>

    <script>
        function logout() { localStorage.clear(); window.location.href = '/'; }

        async function loadUsers() {
            const res = await fetch('/api/users');
            const data = await res.json();
            const tbody = document.getElementById('userTable');
            const selStu = document.getElementById('manualStuId');
            const selTut = document.getElementById('manualTutId');

            tbody.innerHTML = '';
            selStu.innerHTML = '<option value="">Seleccionar Alumno</option>';
            selTut.innerHTML = '<option value="">Seleccionar Tutor</option>';

            // Tutors
            if (data.tutors) data.tutors.forEach(t => {
                tbody.innerHTML += `<tr>
                    <td>${t.id}</td>
                    <td>${t.nombre}</td>
                    <td>Tutor (Disp: ${t.disponible})</td>
                    <td>-</td>
                    <td><button onclick="deleteUser(${t.id})">Eliminar</button></td>
                </tr>`;
                // Add to manual assign dropdown
                selTut.innerHTML += `<option value="${t.id}">${t.nombre} (ID:${t.id})</option>`;
            });
            // Students
            if (data.alumnos) data.alumnos.forEach(a => {
                tbody.innerHTML += `<tr>
                    <td>${a.id}</td>
                    <td>${a.nombre}</td>
                    <td>Alumno (${a.carrera})</td>
                    <td>${a.tutorId}</td>
                    <td><button onclick="deleteUser(${a.id})">Eliminar</button></td>
                </tr>`;
                // Add to manual assign dropdown
                selStu.innerHTML += `<option value="${a.id}">${a.nombre} (ID:${a.id})</option>`;
            });
        }

        async function addUser() {
            const role = document.getElementById('newRole').value;
            const nombre = document.getElementById('newName').value.trim();
            const apellidos = document.getElementById('newSurname').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPass').value.trim();
            const carrera = document.getElementById('newDegree').value.trim();

            let missing = [];
            if (!nombre) missing.push("Nombre");
            if (!apellidos) missing.push("Apellidos");
            if (!email) missing.push("Correo");
            if (!password) missing.push("Contrasena");
            if (role === 'Alumno' && !carrera) missing.push("Carrera");

            if (missing.length > 0) {
                alert("Error: Debe rellenar los campos obligatorios: " + missing.join(", "));
                return;
            }

            if (role === 'Tutor' && carrera) {
                alert("Error: Un Tutor no debe tener carrera asignada.");
                return;
            }

            if (!email.endsWith('@uco.es')) {
                alert("Error: El correo debe ser institucional (@uco.es).");
                return;
            }

            const body = { role, nombre, apellidos, email, password, carrera };
            await fetch('/api/users/add', {
                method: 'POST',
                body: JSON.stringify(body)
            });
            // Clear fields ?
            loadUsers();
        }

        async function deleteUser(id) {
            if (!confirm("Seguro que quieres borrar este usuario? Esto borrara tambien sus mensajes y asignaciones.")) return;
            await fetch('/api/users/delete', {
                method: 'POST',
                body: JSON.stringify({ id: id })
            });
            loadUsers();
        }

        async function autoAssign() {
            // Client-side check if everyone is already assigned
            // We need to peek at the logic or just fetch again to be sure
            const res = await fetch('/api/users');
            const data = await res.json();
            let allAssigned = true;
            if (data.alumnos) {
                for (let a of data.alumnos) {
                    if (a.tutorId === -1) {
                        allAssigned = false;
                        break;
                    }
                }
            }
            if (allAssigned) {
                alert("Ya se han asignado todos los usuarios");
                return;
            }

            await fetch('/api/assign', { method: 'POST', body: JSON.stringify({ auto: true }) });
            loadUsers();
            alert('Asignacion automatica completada');
        }

        async function manualAssign() {
            const sid = document.getElementById('manualStuId').value;
            const tid = document.getElementById('manualTutId').value;
            if (!sid || !tid) {
                alert("Seleccione un alumno y un tutor");
                return;
            }
            await fetch('/api/assign', {
                method: 'POST',
                body: JSON.stringify({ auto: false, studentId: parseInt(sid), tutorId: parseInt(tid) })
            });
            loadUsers();
        }

        async function loadAllChats() {
            const res = await fetch('/api/chats/all');
            const data = await res.json();
            const div = document.getElementById('allChats');
            div.innerHTML = '';
            if (data.msgs) {
                data.msgs.forEach(m => {
                    div.innerHTML += `<div class="msg">From ${m.from} to ${m.to}: ${m.content} <small>(${m.date})</small></div>`;
                });
            }
        }

        loadUsers();
    </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <title>Coordinador - UCO</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <header>
        <h1>Panel de Coordinacion</h1>
        <button onclick="logout()">Cerrar Sesion</button>
    </header>
    <div class="container">
        <!-- HU1.1 & HU1.2 -->
        <div class="section">
            <h2>Gestion de Usuarios (HU1)</h2>
            <div style="background:#eee; padding:10px;">
                <h3>Registrar Nuevo Usuario</h3>
                <select id="newRole">
                    <option value="Alumno">Alumno</option>
                    <option value="Tutor">Tutor</option>
                </select>
                <input type="text" id="newName" placeholder="Nombre">
                <input type="text" id="newSurname" placeholder="Apellidos">
                <input type="text" id="newEmail" placeholder="Correo">
                <input type="text" id="newPass" placeholder="Contrasena">
                <input type="text" id="newDegree" placeholder="Carrera (Solo Alumnos)">
                <button onclick="addUser()">Registrar</button>
            </div>
            <h3>Lista de Usuarios</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Rol/Info</th>
                        <th>Tutor ID</th>
                    </tr>
                </thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>

        <!-- HU2.1 & HU2.2 -->
        <div class="section">
            <h2>Asignacion de Tutores (HU2)</h2>
            <button onclick="autoAssign()">Asignar Automaticamente (HU2.1)</button>
            <div style="margin-top:10px;">
                <h3>Asignacion Manual (HU2.2)</h3>
                <input type="number" id="manualStuId" placeholder="ID Alumno">
                <input type="number" id="manualTutId" placeholder="ID Tutor">
                <button onclick="manualAssign()">Asignar</button>
            </div>
        </div>

        <!-- HU3.3 -->
        <div class="section">
            <h2>Supervision de Chats (HU3.3)</h2>
            <button onclick="loadAllChats()">Cargar Historial Completo</button>
            <div id="allChats" class="chat-window" style="height:200px;"></div>
        </div>
    </div>

    <script>
        function logout() { localStorage.clear(); window.location.href = '/'; }

        async function loadUsers() {
            const res = await fetch('/api/users');
            const data = await res.json();
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';

            // Tutors
            if (data.tutors) data.tutors.forEach(t => {
                tbody.innerHTML += `<tr><td>${t.id}</td><td>${t.nombre}</td><td>Tutor (Disp: ${t.disponible})</td><td>-</td></tr>`;
            });
            // Students
            if (data.alumnos) data.alumnos.forEach(a => {
                tbody.innerHTML += `<tr><td>${a.id}</td><td>${a.nombre}</td><td>Alumno (${a.carrera})</td><td>${a.tutorId}</td></tr>`;
            });
        }

        async function addUser() {
            const role = document.getElementById('newRole').value;
            const body = {
                role: role,
                nombre: document.getElementById('newName').value,
                apellidos: document.getElementById('newSurname').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPass').value,
                carrera: document.getElementById('newDegree').value
            };
            await fetch('/api/users/add', {
                method: 'POST',
                body: JSON.stringify(body)
            });
            loadUsers();
        }

        async function autoAssign() {
            await fetch('/api/assign', { method: 'POST', body: JSON.stringify({ auto: true }) });
            loadUsers();
            alert('Asignacion automatica completada');
        }

        async function manualAssign() {
            const sid = parseInt(document.getElementById('manualStuId').value);
            const tid = parseInt(document.getElementById('manualTutId').value);
            await fetch('/api/assign', {
                method: 'POST',
                body: JSON.stringify({ auto: false, studentId: sid, tutorId: tid })
            });
            loadUsers();
        }

        async function loadAllChats() {
            const res = await fetch('/api/chats/all');
            const data = await res.json();
            const div = document.getElementById('allChats');
            div.innerHTML = '';
            if (data.msgs) {
                data.msgs.forEach(m => {
                    div.innerHTML += `<div class="msg">From ${m.from} to ${m.to}: ${m.content} <small>(${m.date})</small></div>`;
                });
            }
        }

        loadUsers();
    </script>
</body>

</html>
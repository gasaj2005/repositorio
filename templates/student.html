<!DOCTYPE html>
<html>

<head>
    <title>Alumno - UCO</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <header>
        <h1>Panel de Alumno</h1>
        <button onclick="logout()">Cerrar Sesion</button>
    </header>
    <div class="container">
        <!-- HU3.1 -->
        <div class="section">
            <h2>Chat con mi Tutor</h2>
            <div id="tutorInfo">Cargando info tutor...</div>
            <div id="chatWindow" class="chat-window"></div>
            <input type="text" id="msgInput" placeholder="Escribe a tu tutor...">
            <button onclick="sendMsg()">Enviar</button>
        </div>
    </div>

    <script>
        let myId = parseInt(localStorage.getItem('userId'));
        let myTutorId = null;

        function logout() { localStorage.clear(); window.location.href = '/'; }

        // We need to fetch who is my tutor. We can reuse the users API or make a specific one.
        // For simplicity, we'll scan the users list or add a "me" endpoint. 
        // Let's use the users list filtered locally for this demo MVP.
        async function getMyTutor() {
            const res = await fetch('/api/users');
            const data = await res.json();
            if (data.alumnos) {
                const me = data.alumnos.find(a => a.id === myId);
                if (me && me.tutorId !== -1) {
                    myTutorId = me.tutorId;
                    const tutorName = data.tutors.find(t => t.id === myTutorId)?.nombre || "Desconocido";
                    document.getElementById('tutorInfo').innerText = "Tu Tutor asignado es: " + tutorName;
                    loadChat();
                } else {
                    document.getElementById('tutorInfo').innerText = "No tienes tutor asignado aun.";
                }
            }
        }

        async function loadChat() {
            if (!myTutorId) return;
            const res = await fetch(`/api/chat/history?u1=${myId}&u2=${myTutorId}`);
            const data = await res.json();
            const div = document.getElementById('chatWindow');
            div.innerHTML = '';
            if (data.msgs) {
                data.msgs.forEach(m => {
                    const isMe = m.from === myId;
                    const style = isMe ? 'text-align:right; background:#dcf8c6;' : 'background:#fff;';
                    // Add delete button if it's my message
                    const delBtn = isMe ? `<button onclick="deleteMsg(${m.id})" style="font-size:0.8em; margin-left:5px; color:red;">x</button>` : '';

                    div.innerHTML += `<div class="msg" style="${style} padding:5px; margin:2px;">
                         <b>${isMe ? 'Yo' : 'Tutor'}:</b> ${m.content} ${delBtn}
                    </div>`;
                });
                div.scrollTop = div.scrollHeight;
            }
        }

        async function deleteMsg(id) {
            if (!confirm("Borrar mensaje?")) return;
            try {
                const res = await fetch('/api/chat/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                if (res.ok) {
                    // alert("Mensaje borrado");
                } else {
                    alert("Error al borrar el mensaje");
                }
            } catch (e) {
                alert("Error de red: " + e);
            }
            loadChat();
        }

        async function sendMsg() {
            const txt = document.getElementById('msgInput').value;
            if (!txt || !myTutorId) return;

            await fetch('/api/chat/send', {
                method: 'POST',
                body: JSON.stringify({ from: myId, to: myTutorId, content: txt })
            });
            document.getElementById('msgInput').value = '';
            loadChat();
        }

        // Send on Enter
        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMsg();
        });

        setInterval(loadChat, 1000);
        getMyTutor();
    </script>
</body>

</html>